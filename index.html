<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.youtube.com https://www.gstatic.com https://apis.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' https://www.gstatic.com https://apis.google.com https://firebaseapp.com https://firebaseio.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com; frame-src 'self' https://www.youtube.com https://youtube.com https://fantasia-3c631.firebaseapp.com https://apis.google.com;">
    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="crimson">
    <meta name="description" content="Fantasia music theory tools: chord generator, chord progressions, and theory explorer.">
    <title>Fantasia</title>
    <link rel="stylesheet" href="./src/styles/app.css?v=3.0">
    <link rel="stylesheet" href="./pages/css/chordGenerator.css?v=1.6">
    <link rel="stylesheet" href="./pages/css/chordProgression.css?v=1.4">
    <link rel="stylesheet" href="./pages/css/musicTheory.css?v=1.4">
    <link rel="stylesheet" href="./pages/css/progressionInfo.css?v=1.4">
    <link rel="stylesheet" href="./pages/css/pomodoro.css?v=1.2">
    <link rel="stylesheet" href="./pages/css/profile.css?v=1.1">
    <link rel="stylesheet" href="./pages/css/chat.css?v=1.1">
    <link rel="stylesheet" href="./pages/css/rank.css?v=1.0">
</head>
<body>
    <div class="container">
        <!-- Top Bar (appears on hover) -->
        <div class="top-bar">
            <div class="top-bar-left">
                <button id="chatBtn" class="chat-btn" title="Chat Room">üí¨</button>
                <button id="rankBtn" class="rank-btn" title="Leaderboard">üèÜ</button>
            </div>
            <div class="top-bar-right">
                <button id="settingsBtn" class="settings-btn" title="Settings">‚öôÔ∏è</button>
                <div id="authContainer"></div>
            </div>
        </div>
        
        <!-- Floating Title -->
        <div class="floating-title">‚úß Fantasia ‚úß</div>
        
        <!-- Settings Panel (outside header so it's always accessible) -->
        <div id="settingsPanel" class="settings-panel">
            <div class="sounds-control-panel">
                <button class="settings-close-btn" id="settingsCloseBtn" title="Close">‚úï</button>
                <div class="sound-section">
                    <div class="sound-header">
                        <button id="musicToggleBtn" class="sound-btn" aria-label="Toggle Music">üéµ</button>
                        <input type="range" id="volumeSlider" class="sound-slider" min="0" max="100" value="15">
                        <span id="volumeLabel" class="sound-label">15%</span>
                    </div>
                </div>
                <div class="sound-section">
                    <div class="sound-header">
                        <button id="sfxToggleBtn" class="sound-btn" aria-label="Toggle SFX">üîä</button>
                        <input type="range" id="sfxSlider" class="sound-slider" min="0" max="100" value="50">
                        <span id="sfxLabel" class="sound-label">50%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rank Panel -->
        <div id="rankPanel" class="rank-panel" style="display: none;">
            <div class="rank-panel-content">
                <div class="rank-header">
                    <h2>üèÜ Leaderboard</h2>
                    <button class="rank-close-btn" id="rankCloseBtn" title="Close">‚úï</button>
                </div>
                <div class="rank-list" id="rankList">
                    <div class="rank-loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- Default Header -->
        <header id="pageTitle">Fantasia
            <button id="backBtn" class="back-btn" style="display: none;">‚Üê</button>
        </header>

        <main id="mainContent">
            <!-- HOME PAGE -->
            <section id="homePage" class="page-section" style="display: flex; align-items: center; justify-content: center; flex: 1;">
                <div style="display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap;">
                    <!-- Tools Section -->
                    <div class="nav-category">
                        <h1 style="text-align: center; color: var(--theme); margin-bottom: 2.5rem; font-size: 1.5em;">Tools</h1>
                        <div class="nav-boxes-container" style="display: flex; flex-direction: row; gap: 1rem;">
                            <a href="chord-generator.html" class="section-box-card">
                                <div class="section-box-icon">üéπ</div>
                                <div class="section-box-title">Chord Generator</div>
                            </a>
                            <a href="pomodoro.html" class="section-box-card">
                                <div class="section-box-icon">üçÖ</div>
                                <div class="section-box-title">Pomodoro</div>
                            </a>
                        </div>
                    </div>

                    <!-- Data Section -->
                    <div class="nav-category">
                        <h1 style="text-align: center; color: var(--theme); margin-bottom: 2.5rem; font-size: 1.5em;">Data</h1>
                        <div class="nav-boxes-container" style="display: flex; flex-direction: row; gap: 1rem;">
                            <a href="chord-progression.html" class="section-box-card">
                                <div class="section-box-icon">üéº</div>
                                <div class="section-box-title">Chord Progression</div>
                            </a>
                            <a href="music-theory.html" class="section-box-card">
                                <div class="section-box-icon">üìö</div>
                                <div class="section-box-title">Music Theory</div>
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CHORD PROGRESSION PAGE -->
            <section id="chordProgressionPage" class="page-section" style="display: none;">
                <div id="progressionControls" class="progression-controls"></div>
                
                <!-- Skeleton Loading -->
                <div id="progressionsSkeleton" class="skeleton-container" style="display: none;">
                    <div class="skeleton skeleton-bar"></div>
                    <div class="skeleton skeleton-bar"></div>
                    <div class="skeleton skeleton-bar"></div>
                    <div class="skeleton skeleton-bar"></div>
                </div>
                
                <!-- Error Message -->
                <div id="progressionsError" class="error-message">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">Failed to Load Progressions</div>
                    <div class="error-text">We couldn't load the chord progressions. Please check your connection and try again.</div>
                    <button class="error-button" onclick="location.reload()">Reload Page</button>
                </div>
                
                <div id="progressionsList" class="progressions-list">
                    <!-- Progressions render here -->
                </div>
            </section>

            <!-- PROGRESSION INFO PAGE -->
            <section id="progressionInfoPage" class="page-section" style="display: none;">
                <div class="detail-controls" id="detailControls"></div>
                
                <!-- Skeleton Loading -->
                <div id="progressionInfoSkeleton" class="skeleton-container" style="display: none;">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text short"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text short"></div>
                </div>
                
                <!-- Error Message -->
                <div id="progressionInfoError" class="error-message">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">Failed to Load Details</div>
                    <div class="error-text">We couldn't load the progression details. Please try again.</div>
                    <button class="error-button" onclick="history.back()">Go Back</button>
                </div>
                
                <div class="detail-content" id="detailContent">
                    <!-- Detail content will be loaded here -->
                </div>
            </section>

            <!-- MUSIC THEORY PAGE -->
            <section id="musicTheoryPage" class="page-section" style="display: none;">
                <!-- Skeleton Loading -->
                <div id="theorySkeleton" class="skeleton-container" style="display: none;">
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
                
                <!-- Error Message -->
                <div id="theoryError" class="error-message">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">Failed to Load Music Theory</div>
                    <div class="error-text">We couldn't load the music theory content. Please check your connection and try again.</div>
                    <button class="error-button" onclick="location.reload()">Reload Page</button>
                </div>
                
                <div class="theory-list-container" id="theoryList">
                    <!-- Theory list will be loaded here -->
                </div>
            </section>

            <!-- CHORD GENERATOR PAGE -->
            <section id="chordGeneratorPage" class="page-section" style="display: none;">
                <div class="generator-container">
                    <!-- Generator content will be loaded here -->
                </div>
            </section>

            <!-- POMODORO PAGE -->
            <section id="pomodoroPage" class="page-section" style="display: none;">
                <div class="pomodoro-container">
                    <!-- Left Panel - Missions -->
                    <div class="panel missions-panel" id="missions-panel">
                        <h2>Missions</h2>
                        <div class="cards-container" id="missions-container" data-zone="missions">
                            <div class="add-card-section">
                                <button class="add-mission-btn-icon" id="add-mission-btn-icon">+</button>
                                <input type="text" id="new-mission-input" placeholder="Enter new mission...">
                            </div>
                        </div>
                    </div>

                    <!-- Middle Panel - Pomodoro Timer -->
                    <div class="panel pomodoro-panel" id="pomodoro-panel">
                        <div class="drop-zone" id="pomodoro-zone" data-zone="pomodoro">
                            <p class="drop-hint">Drag a mission here to start</p>
                            <div class="active-mission" id="active-mission" style="display: none;"></div>
                        </div>
                        <div class="timer-section" id="timer-section" style="display: none;">
                            <div class="timer-display-row">
                                <div class="timer-display">
                                    <span id="timer-mode">Work</span>
                                    <span id="timer-countdown">50:00</span>
                                </div>
                                <button class="timer-settings-btn" id="timer-settings-btn" title="Settings">‚öô</button>
                            </div>
                            <div class="timer-controls">
                                <button id="start-btn">Start</button>
                                <button id="pause-btn" style="display: none;">Pause</button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Finished -->
                    <div class="panel finished-panel" id="finished-panel">
                        <h2>Finished</h2>
                        <div class="cards-container" id="finished-container" data-zone="finished">
                        </div>
                    </div>
                </div>

                <!-- Edit Modal -->
                <div class="modal" id="edit-modal" style="display: none;">
                    <div class="modal-content">
                        <h3>Edit Mission</h3>
                        <input type="text" id="edit-mission-input">
                        <div class="modal-buttons">
                            <button id="save-edit-btn">Save</button>
                            <button id="cancel-edit-btn">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Timer Settings Modal -->
                <div class="modal" id="timer-settings-modal" style="display: none;">
                    <div class="modal-content">
                        <h3>Timer Settings</h3>
                        <div class="timer-settings-inputs">
                            <div class="time-input">
                                <label>Work Time (minutes):</label>
                                <input type="number" id="work-time-modal" value="50" min="1" max="60">
                            </div>
                            <div class="time-input">
                                <label>Rest Time (minutes):</label>
                                <input type="number" id="rest-time-modal" value="10" min="1" max="30">
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button id="save-timer-settings-btn">Save</button>
                            <button id="cancel-timer-settings-btn">Cancel</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- USER PROFILE PAGE -->
            <section id="profilePage" class="page-section" style="display: none;">
                <div id="profileContent"></div>
            </section>

            <!-- CHAT ROOM PAGE -->
            <section id="chatPage" class="page-section" style="display: none;">
                <div id="chatContent"></div>
            </section>
        </main>

        <footer>
            <p>&copy; 2026 Fantasia &middot; Aino ‚ù§Ô∏è</p>
        </footer>
    </div>

    <script src="./src/scripts/app.js?v=2.4" defer></script>
    <script src="./pages/js/chordProgression.js?v=2.0" defer></script>
    <script src="./pages/js/chordGenerator.js?v=2.0" defer></script>
    <script src="./pages/js/progressInfo.js?v=2.0" defer></script>
    <script src="./pages/js/musicTheory.js?v=2.0" defer></script>
    <script src="./pages/js/pomodoro.js?v=1.0" defer></script>
    
    <!-- Firebase Authentication, Settings Sync & Features -->
    <script type="module">
        import { initAuthUI } from './src/auth/auth-ui.js';
        import { saveSettingToCloud, saveAllSettingsToCloud, loadSettingsFromCloud, onLoginSync } from './src/auth/settings-sync.js';
        import { initRankPanel, recordWorkSession } from './src/scripts/rank.js';
        import './src/auth/profile.js';
        import './src/auth/chat.js';
        
        // Expose sync functions to non-module scripts (app.js)
        window.cloudSync = { saveSettingToCloud, saveAllSettingsToCloud, loadSettingsFromCloud, onLoginSync };
        
        // Expose rank functions
        window.recordWorkSession = recordWorkSession;
        
        initAuthUI();
        initRankPanel();
    </script>
</body>
</html>
